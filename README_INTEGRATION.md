# Интеграция с Реални Бази Данни и API - Ръководство

## Преглед

Този проект интегрира всички данни от `legal data` папката в виртуална база данни и добавя интеграция с реални API за български кредитори.

## Структура на Решението

### 1. Универсален Импорт Скрипт
**Файл**: `import_all_legal_data_comprehensive.py`

Импортира всички данни от `legal data` папката:
- Правни документи (PDF, DOCX, RTF)
- Регистри (XLS, XLSX, DOC)
- CSV файлове
- Автоматично извличане на кредитори от регистри

**Използване**:
```bash
python import_all_legal_data_comprehensive.py
```

### 2. Подобрена API Интеграция
**Файл**: `scrapers/enhanced_bulgarian_apis.py`

Интеграция с реални API endpoints:
- **BNB (Българска народна банка)**: Регистър на банки
- **FSC (Комисия за финансов надзор)**: Небанкови финансови институции
- **Trade Register**: Информация за компании
- **APIS.bg**: Данни за нарушения

**Използване**:
```python
from scrapers.enhanced_bulgarian_apis import EnhancedBulgarianAPIs

api = EnhancedBulgarianAPIs()
stats = api.sync_all_creditors()
```

### 3. Виртуална База Данни
**Файл**: `database/virtual_db.py`

Унифициран интерфейс за достъп до всички данни:
- Търсене на кредитори с филтри
- Детайлна информация за кредитори
- Търсене в правни документи
- Статистики

**Използване**:
```python
from database.virtual_db import VirtualDatabase

db = VirtualDatabase()
results = db.search_creditors(query="банка", limit=10)
stats = db.get_statistics()
```

### 4. Оптимизация на Данните
**Файл**: `database/data_optimizer.py`

Оптимизира структурата на базата данни:
- Създава индекси за по-бързо търсене
- Премахва дубликати
- Оптимизира таблици (VACUUM, ANALYZE)
- Обновява статистики

**Използване**:
```bash
python database/data_optimizer.py
```

### 5. Унифицирана Интеграция
**Файл**: `integrate_all_sources.py`

Обединява всички източници в една система:
1. Импортира данни от local folder
2. Синхронизира с реални API
3. Оптимизира структурата
4. Показва статистики

**Използване**:
```bash
python integrate_all_sources.py
```

## API Endpoints

### Синхронизация на Кредитори
```http
POST /api/creditors/sync
```

Синхронизира кредитори от:
- BNB регистър
- FSC регистър
- Локални файлове
- APIS.bg нарушения

### Търсене на Кредитори
```http
GET /api/creditors?search=банка&creditor_type=bank&limit=50&offset=0
```

Параметри:
- `search`: Търсене по име или БУЛСТАТ
- `creditor_type`: Филтър по тип (bank, non-bank, unknown)
- `min_risk_score`: Минимален риск скор
- `blacklisted_only`: Само черен списък
- `limit`: Брой резултати
- `offset`: Пагинация

## Структура на Данните

### Кредитори
- Име, тип, БУЛСТАТ
- Лиценз номер, адрес
- Брой нарушения, риск скор
- Статус (черен списък)

### Правни Документи
- Заглавие, тип документ
- Номер на документ
- Пълно съдържание
- Източник (URL или файл)

### Нарушения
- Тип нарушение
- Описание
- Законова основа
- Орган (КЗП, БНБ, Съд)
- Размер на глоба
- Тежест (critical, high, medium, low)

## Оптимизация

### Индекси
Създадени са следните индекси за по-бързо търсене:
- `ix_creditor_name_lower`: Търсене по име (case-insensitive)
- `ix_creditor_bulstat_lower`: Търсене по БУЛСТАТ
- `ix_creditor_type_risk`: Композитен индекс (тип + риск)
- `ix_violation_creditor_severity`: Композитен индекс (кредитор + тежест)
- `ix_legal_doc_title_lower`: Търсене в правни документи

### Дедупликация
Автоматично премахване на дубликати по БУЛСТАТ с обединяване на данни.

## Статистики

След импорт можете да видите статистики:
```python
from database.virtual_db import VirtualDatabase

db = VirtualDatabase()
stats = db.get_statistics()
print(stats)
```

Включва:
- Общ брой кредитори (банки, небанкови, черен списък)
- Брой нарушения по тежест
- Брой правни документи по тип
- Брой несправедливи клаузи
- Брой съдебни дела

## Следващи Стъпки

1. **Регулярна синхронизация**: Настройте cron job за автоматична синхронизация
2. **Кеширане**: Добавете кеширане за API заявки
3. **Мониторинг**: Добавете мониторинг за API статус
4. **Уведомления**: Добавете уведомления при нови нарушения

## Поддръжка

За проблеми или въпроси:
1. Проверете логовете в `backend.log`
2. Проверете статистиките в базата данни
3. Тествайте API endpoints с curl или Postman

## Лиценз

Този проект е част от Credit Guardian системата.

